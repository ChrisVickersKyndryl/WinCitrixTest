# There are 3 different server types.
# Each running different services
# Each of the 3 has different service states

#servers_dcc:
#  - 
#  -
#servers_storefront:
#  -
#  -
#servers_pvs:
#  -
#  -

# Create 3 server lists. These can be overridden in the template variables

vars:
  servers_storefront: []
  servers_dcc: []
  servers_pvs: []

tasks:

  # Set a default value for the summary. Any changes will change it from this. 
  - name: Set status
    set_facts:
      service_summary: "All servers working correctly"
      
  # Create a temp folder to store all the information
  - name: Create temp folder
    file:
      path: /tmp/MyTest
      state: directory
    delegate_to: 127.0.0.1
    run_once: true

  # Create a temporary file to store the text information from all tests
  - name: Creating an empty file
    file:
      path: "/tmp/MyTest/MyFile.txt"
      state: touch
    delegate_to: 127.0.0.1
    run_once: true

  # Carryout custom checks only on servers in the storefront list
  - name: Check store_front
    include_tasks: tasks/Check_StoreFront.yml
    # loop: "{{ servers_storefront }}"
    when: ansible_hostname in servers_storefront

   # Carryout custom checks only on servers in the DDC list
   - name: check ddc
     include_tasks: tasks/Check_DDC.yml
     # loop: "{{ servers_dcc }}"
     when: ansible_hostname in servers_ddc

   # Carryout custom checks only on servers in the storefront list
   - name: check pvs
     include_tasks: tasks/Check_PVC.yml
     # loop: "{{ servers_pvs }}"
     when: ansible_hostname in servers_pvs

  # Read all the information from the temporary file and copy it into a fact
  - name: read information from file
    set_fact:
      file_text: "{{ lookup('file', '/tmp/MyTest/MyFile.txt') }}"
    run_once: true
    delegate_to: 127.0.0.1

  # Print output to Ansible tower
  - name: Print version
    debug:
      msg: 
        - "Service summary: {{ service_summary }}"
        - "Status: {{ file_text }}"

  # Send email using SMTP
  - name: email information
    mail:
      host: 
      port: 25
      to: Chris Vickers <john.smith@example.com>
      subject: "Server status '{{ service_summary }}'"
      body: '{{ file_text }}'
    delegate_to: localhost
    run_once: true
